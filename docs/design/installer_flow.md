# Webインストーラー フロー設計書

## 1. 設計思想

*   `specification.md` の要件に基づき、**コマンドライン操作を一切不要**とし、ブラウザ上のGUI操作のみでアプリケーションのインストールを完結させることを目指します。
*   実績のあるOSSパッケージ `rashidulhasan/laravel-installer` を活用し、堅牢で分かりやすいインストール体験を提供します。
*   各ステップでユーザーに必要な情報を明確に伝え、エラーが発生した場合はその原因と対処法を分かりやすく提示します。

## 2. インストールフロー

ユーザーがアプリケーションのURLに初めてアクセスすると、インストール済みかどうかを判定し、未インストールの場合は `/install` にリダイレクトされます。

### ステップ1: Welcomeページ

*   **URL:** `/install`
*   **表示内容:**
    *   アプリケーション名の表示と歓迎メッセージ。
    *   「インストール開始」ボタン。
*   **内部処理:** なし。

### ステップ2: サーバー要件チェック

*   **URL:** `/install/requirements`
*   **表示内容:**
    *   PHPのバージョン、必須PHP拡張機能（例: `openssl`, `pdo`, `mbstring`）などの充足状況をリストで表示します。
    *   各項目が要件を満たしていれば緑色のチェックマーク、満たしていなければ赤色のバツ印とエラーメッセージを表示します。
*   **内部処理:** `rashidulhasan/laravel-installer` が定義する要件リストをチェックします。
*   **分岐:** すべての要件を満たしている場合のみ、「次へ」ボタンが有効になります。

### ステップ3: ディレクトリ権限チェック

*   **URL:** `/install/permissions`
*   **表示内容:**
    *   `storage` ディレクトリや `bootstrap/cache` ディレクトリなど、書き込み権限が必要なディレクトリの権限をチェックし、結果をリストで表示します。
    *   権限が正しければ緑色のチェックマーク、不足していれば赤色のバツ印とエラーメッセージ（推奨される権限など）を表示します。
*   **内部処理:** `rashidulhasan/laravel-installer` が定義する権限リストをチェックします。
*   **分岐:** すべての権限が正しい場合のみ、「次へ」ボタンが有効になります。

### ステップ4: 環境設定 (.env)

*   **URL:** `/install/environment`
*   **表示内容:**
    *   データベース接続情報を入力するフォームを表示します。
        *   データベースホスト
        *   データベースポート
        *   データベース名
        *   ユーザー名
        *   パスワード
    *   アプリケーションの基本設定項目もここで入力させます。
        *   アプリケーション名
        *   アプリケーションURL
*   **内部処理:**
    *   入力された情報を元に、`.env` ファイルをサーバー上に生成します。
    *   「データベース接続をテスト」ボタンを設け、入力された情報で実際にDB接続を試み、成否をフィードバックすることが望ましいです。
*   **分岐:** `.env` ファイルの生成に成功すると、「インストール実行」ボタンが有効になります。

### ステップ4.1: システム識別子の生成

*   **URL:** `/install/generate-identifier` (内部処理のためユーザーには表示されない可能性あり)
*   **表示内容:**
    *   「システム識別子を生成しています...」のようなメッセージ。
*   **内部処理:**
    *   UUIDなどの衝突しにくい形式で、システム固有のユニークな識別子を生成します。
    *   生成した識別子を `.env` ファイルに `APP_IDENTIFIER` として追記または更新します。
*   **分岐:** 識別子の生成と保存に成功したら、次のステップへ自動的に進みます。

### ステップ5: インストール実行 (マイグレーション＆DB初期設定)

*   **URL:** `/install/database` (または `/install/finalize`)
*   **表示内容:**
    *   「インストールを実行しています...」のようなメッセージと、プログレスインジケーターを表示します。
    *   バックグラウンドで以下の処理が実行されていることを示します。
        1.  データベースマイグレーションの実行 (`php artisan migrate`)
        2.  （必要であれば）初期データの投入 (`php artisan db:seed`)
*   **内部処理:**
    *   `Artisan::call()` を利用して、プログラム内部からArtisanコマンドを実行します。
    *   すべての処理が成功したことを確認します。
*   **分岐:** 処理が成功したら、最終ステップへリダイレクトします。失敗した場合は、エラーメッセージを表示します。

### ステップ6: 完了

*   **URL:** `/install/final`
*   **表示内容:**
    *   「インストールが完了しました！」というメッセージ。
    *   アプリケーションのトップページへのリンクボタン。
    *   管理画面へのリンクボタン。
*   **内部処理:**
    *   インストールが完了したことを示すフラグファイル（例: `storage/installed`）を作成します。これにより、次回以降 `/install` へのアクセスを防ぎます。

---
**補足:**
*   `rashidulhasan/laravel-installer` は管理者アカウント作成機能を含んでいないため、**初回アクセス時に管理者アカウントを登録する**フローを別途実装する必要があります。
*   インストール完了後、最初のアクセスで `users` テーブルが空の場合に、管理者登録ページにリダイレクトする、といった実装が考えられます。これはインストーラー自体の機能とは別にアプリケーション側のロジックとして実装します。
